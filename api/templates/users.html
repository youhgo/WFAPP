<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Styles pour la modale */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: white;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">

  <button id="logoutButton"
    class="absolute top-4 right-4 py-2 px-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors duration-200 z-50">
    Déconnexion
  </button>

  <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-3xl">
    <h1 class="text-2xl font-bold mb-6 text-center">User Management</h1>

    <div id="userList" class="space-y-4"></div>

    <h2 class="text-xl font-semibold mt-8 mb-4">Add New User</h2>
    <form id="addUserForm" class="space-y-4">
      <input type="text" id="newUsername" placeholder="Username" required
        class="w-full border border-gray-300 rounded-lg p-3">
      <input type="password" id="newPassword" placeholder="Password" required
        class="w-full border border-gray-300 rounded-lg p-3">
      <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors duration-200">Add User</button>
    </form>

    <p id="statusMsg" class="text-center mt-6"></p>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-semibold mb-4">Edit User</h2>
      <form id="editForm" class="space-y-4">
        <input type="hidden" id="editUserId">
        <div>
          <label for="editUsername" class="block text-sm font-medium text-gray-700">Username</label>
          <input type="text" id="editUsername" required
            class="w-full border border-gray-300 rounded-lg p-3 mt-1">
        </div>
        <div>
          <label for="editPassword" class="block text-sm font-medium text-gray-700">Password (leave blank to keep current)</label>
          <input type="password" id="editPassword"
            class="w-full border border-gray-300 rounded-lg p-3 mt-1">
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="editIsAdmin"
            class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <label for="editIsAdmin" class="ml-2 block text-sm text-gray-900">Is Admin</label>
        </div>
        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" id="cancelEditBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors duration-200">
            Annuler
          </button>
          <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">
            Sauvegarder
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
async function fetchUsers() {
  const res = await fetch('/api/users');
  if (!res.ok) {
    if (res.status === 403) {
      document.getElementById('userList').innerHTML = '<p class="text-center text-red-500">Access forbidden. You do not have administrator rights.</p>';
      return;
    }
    document.getElementById('userList').innerHTML = '<p class="text-center text-red-500">Failed to load users.</p>';
    return;
  }
  const users = await res.json();
  const list = document.getElementById('userList');
  list.innerHTML = '';
  users.forEach(user => {
    const div = document.createElement('div');
    div.className = "flex justify-between items-center bg-gray-50 p-4 rounded-lg";
    div.innerHTML = `
      <div class="flex items-center space-x-2">
        <span class="font-medium">${user.username}</span>
        ${user.is_admin ? '<span class="text-xs bg-blue-200 text-blue-800 rounded-full px-2 py-0.5">Admin</span>' : ''}
      </div>
      <div class="space-x-2">
        <button onclick="showEditModal(${user.id}, '${user.username}', ${user.is_admin})"
          class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors duration-200">Edit</button>
        <button onclick="deleteUser(${user.id})"
          class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition-colors duration-200">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}

// Fonction pour afficher la modale d'édition
function showEditModal(id, username, isAdmin) {
  const modal = document.getElementById('editModal');
  document.getElementById('editUserId').value = id;
  document.getElementById('editUsername').value = username;
  document.getElementById('editPassword').value = ''; // toujours vider le champ mot de passe
  document.getElementById('editIsAdmin').checked = isAdmin;
  modal.style.display = 'flex';
}

// Fonction pour cacher la modale d'édition
function hideEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

// Ajout des écouteurs d'événements pour la modale
document.getElementById('cancelEditBtn').addEventListener('click', () => {
  hideEditModal();
});

document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('editUserId').value;
  const username = document.getElementById('editUsername').value;
  const password = document.getElementById('editPassword').value;
  const is_admin = document.getElementById('editIsAdmin').checked;

  const body = { username, is_admin };
  if (password) body.password = password;

  const res = await fetch(`/api/users/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (res.ok) {
    document.getElementById('statusMsg').textContent = "User updated successfully.";
    hideEditModal();
    fetchUsers();
  } else {
    const data = await res.json();
    document.getElementById('statusMsg').textContent = data.message || "Failed to update user.";
  }
});


async function deleteUser(id) {
  if (!confirm("Are you sure you want to delete this user?")) return;
  const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
  if (res.ok) {
    document.getElementById('statusMsg').textContent = "User deleted successfully.";
  } else {
    const data = await res.json();
    document.getElementById('statusMsg').textContent = data.message || "Failed to delete user.";
  }
  fetchUsers();
}

document.getElementById('addUserForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('newUsername').value;
  const password = document.getElementById('newPassword').value;
  const res = await fetch('/api/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });
  if (res.ok) {
    document.getElementById('statusMsg').textContent = "User added successfully.";
    fetchUsers();
    e.target.reset();
  } else {
    const data = await res.json();
    document.getElementById('statusMsg').textContent = data.message || "Failed to add user.";
  }
});

fetchUsers();

// Gérer la déconnexion
document.getElementById('logoutButton').addEventListener('click', async () => {
    try {
        const res = await fetch('/api/logout', { method: 'POST' });
        if (res.ok) {
            window.location.href = '/login_page';
        } else {
            document.getElementById('statusMsg').textContent = "Failed to log out.";
        }
    } catch (error) {
        document.getElementById('statusMsg').textContent = `An error occurred: ${error.message}`;
    }
});
</script>
</body>
</html>